# 반복 학습: 변주 시나리오 & 교차 상황 반복

## 목표

"복습"이라는 단어 없이, 같은 장소의 새로운 상황(변주 시나리오)과
교차 상황 반복(같은 표현이 다른 상황에서 다른 기능으로 등장)을 통해
자연스러운 반복 학습 시스템을 구현합니다.

핵심: **이전 오답이 다음 시나리오의 정답이 되는 구조**

이 플랜에는 다음 기능이 포함되어 있습니다.

1. 변주 시나리오 시스템 — 같은 장소, 다른 상황
2. 오답→정답 재활용 구조 — 선택지 간 교차 활용
3. 교차 상황 반복 — 다의어 깨기 (すみません이 4개 상황에서 다른 기능)
4. 공통 도구 세트 추적 — 상황 관통 공통 표현
5. 간격 반복 타이밍 — "오늘의 추천" 유도

## 요구 결과물

1. `lib/variationEngine.ts` — 변주 시나리오 선택 + 오답→정답 교차 로직
2. `lib/crossSituationTracker.ts` — 교차 상황 표현 추적
3. `components/ToolkitView.tsx` — "나의 도구 세트" 모아보기 UI
4. 변주 시나리오 진입 UX ("새로운 상황 발생!" 배지)
5. 시뮬레이터에서 기본→변주 전환, 교차 반복 확인
6. FSRS 간격 반복과 변주 시나리오의 연동 확인

## 타겟 프로젝트

`app/` (클라이언트) + `scripts/` (데이터 생성) 양쪽을 대상으로 합니다.

## 전체 프로세스 주의사항

1. 하나의 스텝이 완료되면 git commit이 발생되어야 합니다.
2. 하나의 스텝이 완료되면 자동으로 다음 스텝으로 넘어가세요.
3. 모든 프로젝트 작성과, 실행을 통한 검증이 완료되기 전까지는 스텝과 루프를 종료하지 마세요.
4. 더 이상 진행할 수 없을 정도로 모호한 경우에만 중단하고 질문을 요청하세요.
5. 적절한 agent team 멤버를 구성하세요. 모든 작업에는 무조건 리뷰어가 할당되어야 하며, 각 스텝의 완료 직전에도 리뷰가 진행되어야 합니다.
6. 절대 전체 프로세스를 컨텍스트에서 관리하지 마세요. PLAN.md 파일을 이용하십시오.

## 상세 프로세스

### 1. 변주 시나리오 데이터 구조 분석 및 설계

기존 51개 시나리오(기본 22개 + 변주 29개)의 데이터 구조를 분석하고,
v1 기획서의 변주 시나리오 구조에 맞게 재설계합니다.

**v1 변주 시나리오 구조:**

| 장소 | 기본 | 변주 1 | 변주 2 | 변주 3 |
|------|------|--------|--------|--------|
| 식당 | 기본 주문 | 없는 메뉴 질문 | 알레르기 확인 | 친구 것 대신 주문 |
| 편의점 | 물건 구매 | 택배 보내기 | ATM 위치 | 전자레인지 부탁 |
| 전철 | 목적지 이동 | 환승 묻기 | IC카드 충전 | 분실물 문의 |
| 호텔 | 체크인 | 체크아웃 변경 | 룸서비스 | 주변 식당 추천 |

**오답→정답 교차 구조:**

한 시나리오에서 보여준 3개 선택지(정답 1 + 오답 2) 중 오답이
다음 변주 시나리오에서 정답이 됩니다. 이를 통해 한 번의 활동에서
3개 표현이 동시에 노출되고, 변주에서 각각 재활용됩니다.

**데이터 모델:**

```typescript
interface VariationLink {
  baseSituation: string;          // 'restaurant'
  variationSlug: string;          // 'restaurant_allergy'
  prerequisite: string;           // 'restaurant' (기본 완료 필요)
  reusedExpressions: {
    expression: string;           // 'ひとりです'
    roleInBase: 'wrong_choice';   // 기본 시나리오에서의 역할
    roleInVariation: 'correct';   // 변주에서의 역할
  }[];
}
```

해당 작업에는 다음 에이전틱 팀이 구성되어야 합니다.

1. 데이터 아키텍트 — 변주 연결 데이터 모델 설계
2. SLA 리뷰어 — 오답→정답 재활용의 학습 효과 검증

### 2. 교차 상황 반복 시스템 구현

같은 표현이 여러 상황에서 다른 기능으로 등장하는 시스템을 구현합니다.
목표: L1 번역어 하나에 고정되지 않는 L2 고유 개념 범주 형성.

**すみません 교차 반복 예시:**

| 상황 | 기능 | 시각화 |
|------|------|--------|
| 공항 | 직원에게 말 걸기 | 손 드는 그림 |
| 전철 | 양해 구하기 | 좁은 통로 그림 |
| 식당 | 점원 호출 | 점원 부르는 그림 |
| 거리 | 부딪힌 후 사과 | 고개 숙이는 그림 |

4번의 노출이 "실례합니다"라는 고정 번역이 아닌,
**여러 상황에서 쓰는 쿠션 표현**이라는 L2 고유 개념 범주를 형성합니다.

**구현:**
- `crossSituationTracker.ts`: 표현별 등장 상황 목록 추적
- 각 등장마다 다른 그림(이모지)으로 시각화
- 3개 이상 상황에서 등장한 표현에 특별 태그 (도구 세트 등재)

해당 작업에는 다음 에이전틱 팀이 구성되어야 합니다.

1. 프론트엔드 엔지니어 — 추적 로직 + UI
2. 데이터 분석가 — 기존 51개 시나리오에서 교차 등장 표현 추출

### 3. 공통 도구 세트 구현

상황을 관통하는 공통 표현을 "도구 세트"로 추적하고 모아보기 UI를 구현합니다.

**공통 도구 세트 카테고리 (v1 기획서):**

| 카테고리 | 표현 예시 | 도입 상황 |
|----------|----------|----------|
| 인사 | こんにちは, ありがとう, すみません | 공항 |
| 숫자 | ひとつ~とお, ひゃく, せん | 전철 |
| 질문 | ～はどこですか, ～はいくらですか | 공항/편의점 |
| 요청 | ～をください, ～をおねがいします | 편의점/호텔 |
| 확인 | はい, いいえ, だいじょうぶです | 전 상황 |
| 긴급 | たすけてください, いたい | 긴급상황 |

**구현:**
- 별도 학습 메뉴 없음
- 상황 내 자연 포함 + 하이라이트 + 리뷰에서 🔧 태그
- 메인 지도 하단에 "나의 도구 세트" 모아보기
- `ToolkitView.tsx`: 카테고리별 표현 목록 + 🔊 재생 + 습득 상태

해당 작업에는 다음 에이전틱 팀이 구성되어야 합니다.

1. 프론트엔드 엔지니어
2. UX 리뷰어 — 도구 세트가 "학습 목록"이 아닌 "여행 도구"처럼 느껴지는지 검증

### 4. 간격 반복 + 변주 시나리오 연동

기존 FSRS 알고리즘(`fsrs.ts`)과 변주 시나리오 시스템을 연동합니다.

**간격 반복 타이밍:**
1일 → 3일 → 7일 → 14일 → 30일

**연동 방식:**
- 기본 상황 완료 후, FSRS 스케줄에 따라 "오늘의 추천"으로 변주 시나리오 유도
- 같은 장소의 변주를 순서대로 추천 (변주 1 → 2 → 3)
- 변주 시나리오 자체도 FSRS 카드로 등록
- "오늘의 추천 상황"으로 유도. 복습 로직 비노출.

**UX:**
- 기본 완료 후 해당 장소에 "새로운 상황 발생!" 배지
- 지도에서 해당 노드에 숫자 배지 (+1, +2)

해당 작업에는 다음 에이전틱 팀이 구성되어야 합니다.

1. 프론트엔드 엔지니어 — FSRS 연동 + 배지 UI
2. QA 엔지니어 — 타이밍 시뮬레이션 (날짜 변경하여 추천 로직 확인)

### 5. 통합 테스트

식당 상황의 기본→변주 전체 사이클을 테스트합니다.

**테스트 시나리오:**
- 식당 기본 완료 → "새로운 상황 발생!" 배지 표시
- 변주 1(없는 메뉴) 진입 → 기본에서 오답이었던 선택지가 정답으로 등장
- すみません이 공항→전철→식당에서 다른 그림으로 등장
- 도구 세트에 すみません이 3개 상황과 함께 기록
- 3일 후(시뮬레이션): "오늘의 추천"에 식당 변주 2 추천
- FSRS 스케줄과 변주 추천이 충돌 없이 작동

해당 작업에는 다음 에이전틱 팀이 구성되어야 합니다.

1. QA 엔지니어 2명 — 변주 사이클 + 교차 반복 테스트
2. 프론트엔드 엔지니어 — 버그 수정

## 참고사항

1. 기존 29개 변주 시나리오(`scripts/output/`)가 이미 존재합니다. 이 데이터를 최대한 활용하세요.
2. `scripts/situations.json`에 `base_situation` 필드로 변주 관계가 정의되어 있을 수 있습니다. 확인하세요.
3. 이 프롬프트는 `03-four-phase-learning.md`의 Phase 2(포착) 선택지와 직접 연관됩니다.
4. 교차 상황 표현 데이터는 `scripts/output/*.json`의 `key_expressions`에서 추출 가능합니다.
5. 관련 v1 기획서: `docs/v1/Part3_문자_반복_AI_지속성.md` 반복 학습 섹션
