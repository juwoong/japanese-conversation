# AI NPC 대화 파트너 & 피드백 계층화

## 목표

현재의 정적 대사 재생 방식을 AI 기반 NPC 대화 파트너로 교체합니다.
"틀렸습니다" 없이, 오류 유형별 자연스러운 반응(리캐스트/명확화/메타언어적 힌트)으로
피드백을 계층화합니다.

이 플랜에는 다음 기능이 포함되어 있습니다.

1. Claude API를 이용한 NPC 역할 고정 프롬프트 설계
2. 3단계 피드백 분기 (리캐스트 → 명확화 요청 → 메타언어적 힌트)
3. 선택지 생성 규칙 (정답 1 + 올바른 일본어 오답 2)
4. i+1 자연 삽입 및 대화 종결 로직

## 요구 결과물

1. `lib/npcEngine.ts` — NPC 대화 생성 엔진 (Claude API 래퍼)
2. `lib/feedbackLayer.ts` — 피드백 계층화 로직
3. `lib/npcPrompts.ts` — 상황별 시스템 프롬프트 템플릿
4. Phase 3(참여)에서 NPC 엔진 연동 확인
5. 피드백 3단계 분기가 정상 작동하는지 시뮬레이터 검증
6. Edge Function `generate-npc-response` 배포 (클라이언트에 API 키 노출 방지)

## 타겟 프로젝트

`app/` (클라이언트) + `backend/` (Edge Function) 양쪽을 대상으로 합니다.

## 전체 프로세스 주의사항

1. 하나의 스텝이 완료되면 git commit이 발생되어야 합니다.
2. 하나의 스텝이 완료되면 자동으로 다음 스텝으로 넘어가세요.
3. 모든 프로젝트 작성과, 실행을 통한 검증이 완료되기 전까지는 스텝과 루프를 종료하지 마세요.
4. 더 이상 진행할 수 없을 정도로 모호한 경우에만 중단하고 질문을 요청하세요.
5. 적절한 agent team 멤버를 구성하세요. 모든 작업에는 무조건 리뷰어가 할당되어야 하며, 각 스텝의 완료 직전에도 리뷰가 진행되어야 합니다.
6. 절대 전체 프로세스를 컨텍스트에서 관리하지 마세요. PLAN.md 파일을 이용하십시오.

## 상세 프로세스

### 1. NPC 행동 규칙 기반 프롬프트 설계

v1 기획서의 NPC 행동 규칙을 Claude API 시스템 프롬프트로 변환합니다.

**NPC 행동 규칙 (반드시 프롬프트에 포함):**

| 규칙 | 내용 |
|------|------|
| 역할 유지 | 항상 NPC 역할. "그건 ～문법이에요" 안 함 |
| 난이도 적응 | 수준에 맞게 어휘/복잡도 자동 조절 |
| 피드백 계층화 | 리캐스트 / 명확화 요청 / 메타언어적 힌트 배합 |
| 예상 밖 대응 | 식당에서 "トイレどこ?" → 화장실 안내 |
| i+1 삽입 | 모를 법한 표현 하나씩 자연스럽게 |
| 대화 종결 | 5~7턴에 자연스럽게 마무리 |

**프롬프트 구조:**

```
System: 당신은 [상황]의 [역할]입니다. (예: 식당의 점원)
- 항상 일본어로만 응답합니다.
- 사용자의 일본어 수준: [level]
- 사용자 발화에 오류가 있으면:
  1) 의미가 통하면 → 리캐스트 (올바른 형태를 자연스럽게 반복)
  2) 의미가 안 통하면 → もういちどおねがいします
  3) 같은 오류 2회+ → 짧은 힌트 제공
- 대화 5~7턴에 자연스럽게 종결하세요.
- 현재 상황의 핵심 표현: [expressions]
- i+1: 사용자가 아직 모를 법한 표현 하나를 자연스럽게 삽입하세요.
```

해당 작업에는 다음 에이전틱 팀이 구성되어야 합니다.

1. 프롬프트 엔지니어 — Claude API 프롬프트 최적화
2. SLA(제2언어습득) 리뷰어 — 피드백 계층화의 언어학적 적절성 검증

### 2. 피드백 계층화 로직 구현

`feedbackLayer.ts`에 오류 유형별 분기 로직을 구현합니다.

**3단계 분기:**

```
사용자 발화 → STT 텍스트
  ├─ 기대 답변과 의미 일치 + 형태 오류 → ① 리캐스트
  ├─ 기대 답변과 의미 불일치 → ② 명확화 요청
  └─ 같은 오류 2회 연속 → ③ 메타언어적 힌트
```

**① 리캐스트 (강화)**

사용자가 말한 의미는 맞지만 형태에 오류가 있을 때, NPC가 올바른 형태를 자연스럽게 반복합니다.

```
사용자: ビール ふたつ ください
NPC: ビールを ✨ふたつ✨ ですね! しょうしょうおまちください
```

UI에서 교정 부분에 살짝 다른 배경색 + ✨ 표시. 탭하면 "이렇게도 말해요" 팝업.

**② 명확화 요청**

```
사용자: (불명확한 발화)
NPC: すみません、もういちどおねがいします
→ 사용자 재시도 유도
```

**③ 메타언어적 힌트**

같은 오류 2회 이상일 때만. 대화 잠깐 멈추고:

```
💡 숫자 뒤에 つ를 붙이면 물건을 셀 수 있어요
   🔊 ひとつ、ふたつ、みっつ...
   [계속하기]
```

해당 작업에는 다음 에이전틱 팀이 구성되어야 합니다.

1. 프론트엔드 엔지니어 — 피드백 UI 구현
2. 데이터 엔지니어 — 오류 추적 데이터 모델 설계

### 3. 선택지 생성 시스템 구현

Phase 3(참여)에서 사용할 선택지를 생성하는 로직을 구현합니다.

**선택지 생성 규칙:**
- 정답 1개 + 문법적으로 올바른 오답 2개
- 문법 오류를 선택지에 넣지 않음 — 잘못된 형태가 기억에 각인되는 것 방지
- 오답은 "상황이 다를 뿐" — 변주 시나리오에서 정답이 됨

**구현 방식 2가지 (하이브리드):**

1. **정적 선택지**: 각 상황의 JSON 데이터에 미리 정의된 선택지 세트
2. **동적 선택지**: Claude API로 상황에 맞는 선택지 실시간 생성

MVP에서는 정적 선택지를 기본으로 하고, 자유 입력 모드에서만 동적 응답을 사용합니다.

해당 작업에는 5개 이상의 subagent를 이용하십시오.
- 각 subagent는 2개 상황씩 담당하여, 상황별 선택지 데이터를 생성합니다.
- 결과를 `scripts/output/choices/` 폴더에 상황별 JSON으로 저장합니다.

### 4. Edge Function 구현 및 연동

클라이언트에 Claude API 키가 노출되지 않도록 Supabase Edge Function으로 NPC 응답을 생성합니다.

**Edge Function: `generate-npc-response`**

```typescript
// 입력
{
  situation: string;       // 'restaurant'
  userMessage: string;     // STT 결과 텍스트
  conversationHistory: Turn[];
  userLevel: number;
  errorHistory: Error[];   // 같은 오류 추적용
}

// 출력
{
  npcResponse: string;           // NPC 일본어 응답
  feedbackType: 'recast' | 'clarification' | 'meta_hint' | 'none';
  recastHighlight?: string;      // 리캐스트 시 강조 부분
  metaHint?: string;             // 메타언어적 힌트 (한국어)
  shouldEndConversation: boolean;
}
```

해당 작업에는 다음 에이전틱 팀이 구성되어야 합니다.

1. 백엔드 엔지니어 — Edge Function 구현
2. 프론트엔드 엔지니어 — 클라이언트 연동
3. QA 엔지니어 — API 응답 형식 검증

### 5. 통합 테스트

식당 상황에서 다음 시나리오를 테스트합니다.

- 정상 대화: 선택지 → 따라 말하기 → NPC 응답 → 5~7턴 종결
- 리캐스트: 의미 맞지만 형태 오류 시 NPC가 자연스럽게 교정
- 명확화 요청: 인식 불가 발화 시 "もういちど" 요청
- 메타언어적 힌트: 같은 오류 2회 시 한국어 힌트 표시
- 예상 밖 입력: 식당에서 "トイレどこ?" → 화장실 안내
- 묵음 모드: 선택지만으로 대화 진행

해당 작업에는 다음 에이전틱 팀이 구성되어야 합니다.

1. QA 엔지니어 2명 — 피드백 분기별 테스트
2. 프론트엔드 엔지니어 — 버그 수정

## 참고사항

1. Claude API 키는 `backend/.env`의 `ANTHROPIC_API_KEY`에 이미 있습니다. 절대 `.env`를 직접 읽지 마십시오.
2. 기존 Edge Function(`transcribe`, `get-daily-session`, `submit-attempt`)의 패턴을 참고하세요.
3. NPC 응답 지연 시 "..." 타이핑 인디케이터를 표시하세요 (NpcBubble에 통합).
4. 피드백의 ✨ 하이라이트는 기존 `FuriganaText.tsx`의 스타일링을 참고하세요.
5. 관련 v1 기획서: `docs/v1/Part2_4Phase.md` 피드백 섹션 + `docs/v1/Part3_문자_반복_AI_지속성.md` AI 섹션
